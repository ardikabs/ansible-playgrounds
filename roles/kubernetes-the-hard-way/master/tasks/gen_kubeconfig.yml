
- name: Generating kubeconfig
  args:
    chdir: "{{ item.dir }}"
    creates: "{{ item.dest }}"
  shell: |
    /usr/local/bin/kubectl config set-cluster kubernetes \
    --certificate-authority={{ kube_homedir }}/certs/ca.pem \
    --server=https://127.0.0.1:6443 \
    --embed-certs=true \
    --kubeconfig={{ item.dest }} && \

    /usr/local/bin/kubectl config set-credentials {{ item.credential }} \
    --client-certificate={{ kube_homedir }}/certs/{{ item.unit }}.pem \
    --client-key={{ kube_homedir }}/certs/{{ item.unit }}-key.pem \
    --embed-certs=true \
    --kubeconfig={{ item.dest }} && \

    /usr/local/bin/kubectl config set-context default \
    --cluster=kubernetes \
    --user={{ item.credential }} \
    --kubeconfig={{ item.dest }} && \

    /usr/local/bin/kubectl config use-context default --kubeconfig={{ item.dest }}

  with_items:
  - { dir: "{{ kube_homedir }}/controller-manager", unit: "kube-controller-manager",  credential: "system:kube-controller-manager", dest: "{{ kube_homedir }}/controller-manager/kubeconfig"}
  - { dir: "{{ kube_homedir }}/scheduler", unit: "kube-scheduler", credential: "system:kube-scheduler", dest: "{{ kube_homedir }}/scheduler/kubeconfig"}
  - { dir: "{{ kube_homedir }}/kube-proxy", unit: "kube-proxy", credential: "system:kube-proxy", dest: "{{ kube_homedir }}/kube-proxy/kubeconfig"}
  - { dir: "{{ kube_homedir }}", unit: "admin", credential: "admin", dest: "{{ kube_homedir }}/admin.kubeconfig"}
